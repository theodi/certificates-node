<%- include('../../partials/header') %>

<link rel="stylesheet" href="/css/certificate.css">

<section class="content-block white">
  <h1 class="visually-hidden"><%= dataTitle %></h1>
  <% if (certificateState && certificateState !== 'published') { %>
    <div class="certificate-state-notice">
      This certificate is in <strong><%= certificateState %></strong> state.
    </div>
  <% } %>
  <div class='certificate <%= (certificateState && certificateState !== 'published') ? "watermarked" : "" %>' data-watermark="<%= (certificateState && certificateState !== 'published') ? certificateState.toUpperCase() : '' %>">
    <div class="certificate-header">
      <div class="certificate-badge-container">
        <% if (level && level.icon) { %>
          <img src="/<%= level.icon %>" alt="<%= levelName %> badge" class="certificate-badge">
        <% } %>
        <div class="certificate-level-name"><%= levelName %></div>
      </div>
      <div>
        <h2 class="certificate-title"><%= certificateTitle %></h2>
        <div class="certificate-meta">
          <span class='badge localle'><%= jurisdiction %></span>
          <span class='status'><%= status %></span>
        </div>
      </div>
    </div>
    <hr class="certificate-divider">
    <div>
      <p class="certificate-description">
        This certifies that the dataset
        <strong>“<%= dataTitle %>”</strong>
        published by <strong><%= publisher %></strong>
        has attained the
        <strong><%= levelName %></strong>
        level on <%= new Date(createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' }) %>.
      </p>
      <% if (level && level.description) { %>
        <p class="certificate-level-description"><%= level.description %></p>
      <% } %>
    </div>
  </div>

  <% if (certificateState === 'published') { %>
    <div class="embed-button-container">
      <button id="embedButton" class="btn btn-primary embed-button">
        Embed this on your site
      </button>
    </div>
  <% } %>

  <!-- Embed Overlay -->
  <div id="embedOverlay" class="embed-overlay">
    <div class="embed-modal">
      <button id="closeEmbed" class="embed-close">&times;</button>
      
      <h2 class="embed-title">Embed on your site</h2>
      
      <!-- Badge Section -->
      <div class="embed-section">
        <div class="embed-section-header">
          <% if (level && level.icon) { %>
            <img src="/<%= level.icon %>" alt="<%= levelName %> badge" class="embed-section-icon">
          <% } %>
          <div>
            <h3 class="embed-section-title">Badge</h3>
            <p class="embed-section-subtitle"><%= levelName %></p>
          </div>
        </div>
        
        <h4 class="embed-code-title">Use the code below to add this badge to your site</h4>
        <div class="embed-code-container">
          <code id="badgeCode">&lt;script src='<%= baseUrl %>/datasets/<%= datasetId %>/certificates/<%= responseSetId %>/badge.js'&gt;&lt;/script&gt;</code>
        </div>
        <button onclick="copyToClipboard('badgeCode')" class="embed-copy-button">
          Copy code
        </button>
      </div>
      
      <!-- Certificate Section -->
      <div class="embed-section">
        <div class="embed-section-header">
          <img src="/images/certificate-preview.png" alt="Certificate Preview" class="embed-section-icon">
          <div>
            <h3 class="embed-section-title">Certificate</h3>
            <p class="embed-section-subtitle">Full certificate embed</p>
          </div>
        </div>
        
        <h4 class="embed-code-title">Use the code below to embed this certificate on your site</h4>
        <div class="embed-code-container">
          <code id="certificateCode">&lt;iframe height='800' src='<%= baseUrl %>/datasets/<%= datasetId %>/certificates/<%= responseSetId %>/embed' width='600'&gt;&lt;/iframe&gt;</code>
        </div>
        <button onclick="copyToClipboard('certificateCode')" class="embed-copy-button">
          Copy code
        </button>
      </div>
    </div>
  </div>

  <div class="certificate-layout">
    <aside class="summary-sidebar">
      <% if (summary) { %>
        <div class="summary-box">
          <h3>Summary</h3>
          <ul class="summary-list">
            <li>
              <strong>Dataset title:</strong>
              <% if ((summary.title || []).length > 1) { %>
                <ul>
                  <% (summary.title || []).forEach(function(ans){ %>
                    <li><%= ans.text %></li>
                  <% }) %>
                </ul>
              <% } else { %>
                <% const t = (summary.title || [])[0]; %>
                <span><%= t ? t.text : '' %></span>
              <% } %>
            </li>
            <li>
              <strong>Dataset URL:</strong>
              <% if ((summary.url || []).length > 1) { %>
                <ul>
                  <% (summary.url || []).forEach(function(ans){ %>
                    <li>
                      <% if (ans.isLink) { %>
                        <a href="<%= ans.text %>" target="_blank" rel="noopener"><%= ans.text %></a>
                      <% } else { %>
                        <%= ans.text %>
                      <% } %>
                    </li>
                  <% }) %>
                </ul>
              <% } else { %>
                <% const u = (summary.url || [])[0]; %>
                <% if (u && u.isLink) { %>
                  <a href="<%= u.text %>" target="_blank" rel="noopener"><%= u.text %></a>
                <% } else { %>
                  <span><%= u ? u.text : '' %></span>
                <% } %>
              <% } %>
            </li>
            <li>
              <strong>License:</strong>
              <% if ((summary.license || []).length > 1) { %>
                <ul>
                  <% (summary.license || []).forEach(function(ans){ %>
                    <li>
                      <% if (ans.isLink) { %>
                        <a href="<%= ans.text %>" target="_blank" rel="noopener"><%= ans.text %></a>
                      <% } else { %>
                        <%= ans.text %>
                      <% } %>
                    </li>
                  <% }) %>
                </ul>
              <% } else { %>
                <% const lic = (summary.license || [])[0]; %>
                <% if (lic && lic.isLink) { %>
                  <a href="<%= lic.text %>" target="_blank" rel="noopener"><%= lic.text %></a>
                <% } else { %>
                  <span><%= lic ? lic.text : '' %></span>
                <% } %>
              <% } %>
            </li>
            <li>
              <strong>Type of release:</strong>
              <% if ((summary.releaseType || []).length > 1) { %>
                <ul>
                  <% (summary.releaseType || []).forEach(function(ans){ %>
                    <li><%= ans.text %></li>
                  <% }) %>
                </ul>
              <% } else { %>
                <% const rel = (summary.releaseType || [])[0]; %>
                <span><%= rel ? rel.text : '' %></span>
              <% } %>
            </li>
          </ul>
        </div>
      <% } %>
    </aside>
    <div class="main-content">
      <div class='certificate-data'>
        <% sections.forEach(function(section){ %>
          <hr class='heavy'>
          <h3><%= section.title %></h3>
          <ul class="section-items">
            <% section.items.forEach(function(item){ %>
              <li>
                <h4 class="item-title"><%= item.title %></h4>
                <% if ((item.answers || []).length > 1) { %>
                  <ul class='answer-list'>
                    <% item.answers.forEach(function(ans){ %>
                      <li>
                        <% if (ans.isLink) { %>
                          <a href="<%= ans.text %>" class="cropped" target="_blank" rel="noopener"><%= ans.text %></a>
                        <% } else { %>
                          <%= ans.text %>
                        <% } %>
                      </li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <% const only = (item.answers || [])[0]; %>
                  <p class='answer'>
                    <% if (only && only.isLink) { %>
                      <a href="<%= only.text %>" class="cropped" target="_blank" rel="noopener"><%= only.text %></a>
                    <% } else { %>
                      <%= only ? only.text : '' %>
                    <% } %>
                  </p>
                <% } %>
              </li>
            <% }) %>
          </ul>
        <% }) %>
      </div>
    </div>
  </div>

</section>

<% if (certificateState === 'published') { %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const embedButton = document.getElementById('embedButton');
  const embedOverlay = document.getElementById('embedOverlay');
  const closeEmbed = document.getElementById('closeEmbed');

  // Show overlay when embed button is clicked
  embedButton.addEventListener('click', function() {
    embedOverlay.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  });

  // Close overlay when X button is clicked
  closeEmbed.addEventListener('click', function() {
    embedOverlay.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
  });

  // Close overlay when clicking outside the modal
  embedOverlay.addEventListener('click', function(e) {
    if (e.target === embedOverlay) {
      embedOverlay.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  });

  // Close overlay with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && embedOverlay.style.display === 'block') {
      embedOverlay.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  });
});

// Copy to clipboard function
function copyToClipboard(elementId) {
  const element = document.getElementById(elementId);
  const text = element.textContent;
  
  if (navigator.clipboard && window.isSecureContext) {
    // Use modern clipboard API
    navigator.clipboard.writeText(text).then(function() {
      showCopyFeedback(elementId);
    }).catch(function(err) {
      console.error('Failed to copy: ', err);
      fallbackCopyTextToClipboard(text, elementId);
    });
  } else {
    // Fallback for older browsers
    fallbackCopyTextToClipboard(text, elementId);
  }
}

function fallbackCopyTextToClipboard(text, elementId) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.top = '0';
  textArea.style.left = '0';
  textArea.style.position = 'fixed';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      showCopyFeedback(elementId);
    }
  } catch (err) {
    console.error('Fallback: Oops, unable to copy', err);
  }
  
  document.body.removeChild(textArea);
}

function showCopyFeedback(elementId) {
  const button = document.querySelector(`#${elementId}`).nextElementSibling;
  const originalText = button.textContent;
  button.textContent = 'Copied!';
  button.style.background = '#28a745';
  
  setTimeout(function() {
    button.textContent = originalText;
    button.style.background = '#666';
  }, 2000);
}
</script>
<% } %>

<%- include('../../partials/footer') %>


